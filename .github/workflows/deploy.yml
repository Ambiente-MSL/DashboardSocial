name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Monitor
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "========================================="
          echo "ğŸ”„ Iniciando deploy do Monitor"
          echo "========================================="
          
          # Vai para a pasta do projeto
          cd /root/monitor || exit 1
          
          # Exibe branch atual
          echo "ğŸ“ Branch atual:"
          git branch
          
          # Puxa atualizaÃ§Ãµes
          echo "â¬‡ï¸  Fazendo git pull..."
          git pull origin main
          
          # Exibe Ãºltimo commit
          echo "ğŸ“ Ãšltimo commit:"
          git log -1 --oneline
          
          # Para containers antigos
          echo "ğŸ›‘ Parando containers..."
          docker compose down
          
          # Rebuilda e sobe
          echo "ğŸ”¨ Rebuilding e subindo containers..."
          docker compose up -d --build
          
          # Aguarda containers subirem
          echo "â³ Aguardando containers..."
          sleep 10
          
          # Verifica status
          echo "ğŸ“Š Status dos containers:"
          docker compose ps
          
          # Limpa imagens antigas
          echo "ğŸ§¹ Limpando imagens antigas..."
          docker image prune -f
          
          echo "========================================="
          echo "âœ… Deploy concluÃ­do com sucesso!"
          echo "========================================="